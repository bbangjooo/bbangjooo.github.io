<!DOCTYPE html> <html lang=" en "><head> <meta charset="utf-8" /> <title> Matrix Factorization with PyTorch using movielens dataset -bbangjo </title> <meta http-equip="X-UA-Compatible" content="IE=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <meta name="description" content="MF PyTorch implementation- Matrix Factorization with PyTorch using movielens dataset"> <meta name="keywords" content="Matrix Factorization with PyTorch using movielens dataset, bbangjo, Recommendation System,"/> <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" /> <meta content="" property="fb:app_id" /> <meta content="bbangjo" property="og:site_name" /> <meta content="Matrix Factorization with PyTorch using movielens dataset" property="og:title" /> <meta content="article" property="og:type" /> <meta content="MF PyTorch implementation" property="og:description" /> <meta content="https://www.bbangjo.kr/blog/recsys-mfpytorch" property="og:url" /> <meta content="2021-02-18T00:00:00+00:00" property="article:published_time" /> <meta content="https://www.bbangjo.kr/about/" property="article:author" /> <meta content="https://www.bbangjo.krhttps://user-images.githubusercontent.com/51329156/100218541-381d3d80-2f58-11eb-8d71-438e9ed9112f.png" property="og:image" /> <meta content="Recommendation System" property="article:section" /> <!-- Twitter Cards --> <meta name="twitter:card" content="summary" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:title" content="Matrix Factorization with PyTorch using movielens dataset" /> <meta name="twitter:url" content="https://www.bbangjo.kr/blog/recsys-mfpytorch" /> <meta name="twitter:description" content="MF PyTorch implementation" /> <link rel="stylesheet" href="https://www.bbangjo.kr/assets/css/main.css" /> <!-- <link rel="stylesheet" href="https://www.bbangjo.kr/assets/css/custom-style.css" /> --> <link rel="stylesheet" href="https://www.bbangjo.kr/assets/bower_components/lightgallery/dist/css/lightgallery.min.css" /> <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.css" /> <link rel="stylesheet" href="https://www.bbangjo.kr/assets/bower_components/bootstrap/dist/css/bootstrap.min.css" /> <link rel="stylesheet" href="https://www.bbangjo.kr/assets/bower_components/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" /> <link rel="stylesheet" href="https://www.bbangjo.kr/assets/bower_components/icono/dist/icono.min.css" /> <!-- Fonts--> <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet" /> <!-- Favicon --> <link rel="icon" href="https://www.bbangjo.kr/assets/img/favicon.ico" type="image/gif" sizes="16x16" /> <script> var base_url = 'https://www.bbangjo.kr' ; </script> <!-- Jquery --> <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin="anonymous" ></script> <!-- <script src="https://www.bbangjo.kr/assets/bower_components/jquery/dist/jquery.min.js"></script> --> <script src="https://www.bbangjo.kr/assets/bower_components/jquery.easing/jquery.easing.min.js"></script> <script src="https://www.bbangjo.kr/assets/bower_components/bootstrap/dist/js/bootstrap.bundle.min.js"></script> <script src="https://www.bbangjo.kr/assets/bower_components/jquery-mousewheel/jquery.mousewheel.min.js"></script> <script src="https://www.bbangjo.kr/assets/bower_components/ghosthunter/dist/jquery.ghostHunter.min.js"></script> <script src="https://www.bbangjo.kr/assets/bower_components/lightgallery/dist/js/lightgallery-all.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/picturefill/3.0.2/picturefill.min.js"></script> <script src="https://www.bbangjo.kr/assets/bower_components/imagesloaded/imagesloaded.pkgd.min.js"></script> <script src="https://www.bbangjo.kr/assets/bower_components/nanobar/nanobar.min.js"></script> <script src="https://www.bbangjo.kr/assets/bower_components/typewrite/dist/typewrite.min.js"></script> <script src="https://www.bbangjo.kr/assets/js/search.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script> <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script> <!-- for Mathjax support --> <!-- Github Button --> <script async defer src="https://buttons.github.io/buttons.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous" ></script> <!-- (you can remove the below scripts but do buy me a coffee to show some support :) --> <!-- Maker widget <script> (function(d, h, m) { var js, fjs = d.getElementsByTagName(h)[0]; if (d.getElementById(m)) { return; } js = d.createElement(h); js.id = m; js.onload = function() { window.makerWidgetComInit({ position: "left", widget: "ofeeof264otl2l5g-zspk40eq2gaomj2n-higi2qphmveubksi" }); }; js.src = "https://makerwidget.com/js/embed.js"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "dhm"); </script> --> <!-- buy me a coffeee <script data-name="BMC-Widget" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="sujaykundu" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF813F" data-position="right" data-x_margin="10" data-y_margin="10" ></script> --> <!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]--> <!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]--> </head> <body> <nav class="navbar navbar-expand-lg fixed-top navbar-dark" id="topNav"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" > <span class="icono-hamburger" id="navbar-hamburger"> </span> </button> <a class="navbar-brand" href="/">bbangjo</a> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav"> <li class="nav-item"> <a class="nav-link" href="https://www.bbangjo.kr/" >Home</a > </li> <li class="nav-item"> <a class="nav-link" href="https://www.bbangjo.kr/about" >About</a > </li> <li class="nav-item"> <a class="nav-link" href="https://www.bbangjo.kr/blog" >Blog</a > </li> </ul> </div> <!-- <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link" href="https://www.bbangjo.kr/get-started"> Get Started </a> </li> --> <!-- <li class="nav-item"> <a class="nav-link" id="olvy-target"> What's New </a> </li> --> <!-- <li class="nav-item"> <a class="nav-link" href="https://www.bbangjo.kr/styleguide"> Styleguide </a> </li> <li class="nav-item"> <button id="olvy-target" class="btn btn-dark"> What's New </button> </li> --> <ul class="nav justify-content-end"> <li class="nav-item"> <a class="nav-link toggle-search-button" href="#search"> <i class="fa fa-search search-icon" aria-hidden="true"></i> </a> </li> <!-- <li class="nav-item"> <input class="nav-link switch" id="theme-toggle" onclick="modeSwitcher()" type="checkbox" name="checkbox" /> </li> --> </ul> </nav> <!-- Search Form --> <div class="search-form-container"> <form class="search-form"> <fieldset class="search-form__fieldset"> <div class="row"> <div class="col-lg-8 offset-md-2"> <input class="search-form__field" placeholder="Type to Search..." autofocus> <input class="search-form__submit" type="submit" value="search"> </div> </div> </fieldset> </form> <div class="row"> <div class="col-lg-8 offset-md-2 search-results"> <div class="card search-results"></div> </div> </div> <div class="close-search-button search-form-container__close"> <i class="fa fa-times icon"></i> </div> </div><div class="main-container"> <div class="row justify-content-center" id="blog-post-container"> <div class="col-lg-10"><article class="card" itemscope itemtype="http://schema.org/BlogPosting"> <div class="card-header"> <h1 class="post-title" itemprop="name headline">Matrix Factorization with PyTorch using movielens dataset</h1> <h4 class="post-meta">MF PyTorch implementation</h4> <p class="post-summary"> Posted by : <span itemprop="author" itemscope itemtype="http://schema.org/Person"> <span itemprop="name"><a href="https://www.bbangjo.kr/blog/authors/bbangjo">bbangjo</a></span> </span > at <time datetime="2021-02-18 00:00:00 +0000" itemprop="datePublished" >Feb 18, 2021</time > </p> <span class="disqus-comment-count" data-disqus-identifier="/blog/recsys-mfpytorch" ></span> <div class="post-categories"> Category : <a href="/blog/categories/Recommendation System" >Recommendation System</a > </div> </div> <div class="card-body" itemprop="articleBody"> <img class="card-img-top" src="https://user-images.githubusercontent.com/51329156/100218541-381d3d80-2f58-11eb-8d71-438e9ed9112f.png" alt="" /> <br /> <br /> <p>오랜만에 글입니다. 최근에 너무 나태하게 산 것 같아 현타가 오네요.. 해킹공부와 추천 시스템 공부를 이번 방학에는 주로 해왔는데, 추천시스템의 협업 필터링 방식 중 Model-based의 대표적인 기술 <strong>Matrix Factorization(이하 MF)</strong>을 pytorch로 구현한 것에 대해 이야기해보려고 합니다.</p> <p>협업 필터링과 MF에 대해 정리한 글이 많은데, 궁금하신 분들은 각각 <a href="https://scvgoe.github.io/2017-02-01-%ED%98%91%EC%97%85-%ED%95%84%ED%84%B0%EB%A7%81-%EC%B6%94%EC%B2%9C-%EC%8B%9C%EC%8A%A4%ED%85%9C-(Collaborative-Filtering-Recommendation-System)/">여기</a>와 <a href="https://jeongchul.tistory.com/553">여기</a>를 참고하시면 좋을 것 같습니다.</p> <p>제가 구현 실력이 뛰어난 것은 아니기 때문에 참고만 한다는 느낌으로 봐주십쇼🤣</p> <h2 id="-프로토타입">📄 프로토타입</h2> <p>저는 PyTorch로 개발할 때 코드를 총 6부분으로 구분합니다.</p> <ul> <li><strong>Setting</strong></li> <li><strong>Dataset &amp; Dataloader</strong></li> <li><strong>Model</strong></li> <li><strong>Criterion(loss function) &amp; Optimizer</strong></li> <li><strong>train &amp; test</strong></li> <li><strong>run</strong></li> </ul> <p>처음 코드가 시작할 때는 다음과 같은 형태를 가지겠네요.</p> <p><strong>MF.py</strong> :</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="p">...</span>

<span class="c1"># Setting 
</span><span class="k">def</span> <span class="nf">check_positive</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s"> is invalid value. epochs should be positive integer'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">'matrix factorization with pytorch'</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--epochs'</span><span class="p">,</span> <span class="s">'-e'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">check_positive</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--batch'</span><span class="p">,</span> <span class="s">'-b'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">check_positive</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--lr'</span><span class="p">,</span> <span class="s">'-l'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'learning rate'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>


<span class="c1"># Dataset &amp; Dataloader
</span>
<span class="c1"># Model
</span>
<span class="c1"># Criterion &amp; Optimizer
</span>
<span class="c1"># train &amp; test
</span>
<span class="c1"># run
</span></code></pre></div></div> <h3 id="dataset--dataloader">Dataset / Dataloader</h3> <p>PyTorch에서는 MNIST 같이 유명한 데이터에 대해서는 기본적으로 내장된 데이터셋을 제공합니다. 그런데 movielens는 없더라구요 ㅠㅠ 그래서 한번 만들어봤습니다. 이 과정이 필수는 아니지만 PyTorch에서 제공하는 <strong>Dataloader</strong>는 전체 데이터셋을 여러 batch들로 나누고, 섞고, 반복적으로 접근할 수 있게 해줍니다. 그것도 아주 쉬운 방법으로요! 👏 그래서 데이터를 처리하는 과정을 단순화할 수 있고, 코드의 가독성도 높여줍니다.</p> <p>저는 movielens dataset 을 사용했는데, <a href="https://grouplens.org/datasets/movielens/">여기</a>에 가시면 여러 종류의 데이터셋이 있습니다. 저는 이 중 <strong>MovieLens Latest Datasets</strong>을 사용했습니다.</p> <p>이 파트에서 저희가 해야할 일은 커스텀 데이터셋을 <code class="language-plaintext highlighter-rouge">torch.utils.data.Dataset</code>에 상속하고, 아래와 같은 메소드를 오버라이드하는 것입니다.</p> <ul> <li><code class="language-plaintext highlighter-rouge">len(dataset)</code> 에서 호출되는 <code class="language-plaintext highlighter-rouge">__len__</code> 은 데이터셋의 크기를 리턴해야합니다.</li> <li><code class="language-plaintext highlighter-rouge">dataset[i]</code> 에서 호출되는 <code class="language-plaintext highlighter-rouge">__getitem__</code> 은 i번째 샘플을 찾는데 사용됩니다.</li> </ul> <p><a href="https://tutorials.pytorch.kr/beginner/data_loading_tutorial.html">여기</a>에 자세한 설명이 나와있으니 보면서 따라하시면 쉽게 하실 수 있을 겁니다.</p> <p>movielens dataset을 다운로드 받으면 여러 csv 파일이 있는데 그 중 저희가 사용할 데이터셋은 <code class="language-plaintext highlighter-rouge">ratings.csv</code> 입니다. 왜냐하면 <strong>협업 필터링</strong>의 Model based 방식인 MF를 구현 중 이니까요!😁 “<code class="language-plaintext highlighter-rouge">User u</code>가 <code class="language-plaintext highlighter-rouge">Item i</code>에 대해 <code class="language-plaintext highlighter-rouge">Rating r</code>을 남겼다” 라는 사실을 알고 싶은 겁니다.</p> <p><img src="https://user-images.githubusercontent.com/51329156/106460584-e9030400-64d6-11eb-91b9-d229df2292b9.png" alt="image" /></p> <p>이 중 저희가 현재로써는 필요없는 <code class="language-plaintext highlighter-rouge">timestamp</code> 컬럼을 잘라내고 가져오겠습니다. csv파일을 dataframe으로 가져오기 위해 <strong>pandas</strong> 모듈을 사용했습니다.</p> <p><strong>MF.py</strong> :</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="p">...</span>
<span class="c1"># Setting
# Dataset &amp; Dataloader
</span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/movielens/ratings.csv'</span><span class="p">).</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">])</span>

<span class="c1"># Model
</span>
<span class="c1"># Criterion &amp; Optimizer
</span>
<span class="c1"># train &amp; test
</span>
<span class="c1"># run
</span></code></pre></div></div> <p>그리고 위에서 설명한대로 <code class="language-plaintext highlighter-rouge">torch.utils.data.Dataset</code>에 상속한 커스텀 데이터셋을 만들고 두 메소드를 오버라이드하면 됩니다. 저는 데이터를 학습용, 평가용으로 나누기 위해 <strong>sklearn</strong>에서 제공하는 <code class="language-plaintext highlighter-rouge">train_test_split</code> 함수를 사용했습니다. <code class="language-plaintext highlighter-rouge">__getitem__</code>에서는 index를 받아 index에 해당하는 데이터를 뽑고, <code class="language-plaintext highlighter-rouge">__len__</code>에서는 데이터셋의 사이즈를 반환합니다.</p> <p>그리고 만든 데이터셋을 이용해서 데이터로더까지 만들어보겠습니다.</p> <p><strong>MF.py</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="p">...</span>

<span class="c1"># Dataset &amp; Dataloader
</span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/movielens/ratings.csv'</span><span class="p">).</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">MovieLensDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="s">"""
    :param df: rating dataframe, columns: ['userId', 'movieId', 'rating', ...]
    :param train: Using train_test_split from sklearn, if True, train_df is used else test_df.
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">train_size</span> <span class="o">=</span> <span class="n">train_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">train_df</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">test_size</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">train_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">train</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">train_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">test_df</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">userId</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]])</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">LongTensor</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">movieId</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]])</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">([</span><span class="bp">self</span><span class="p">.</span><span class="n">df</span><span class="p">.</span><span class="n">rating</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]])</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="c1"># Model
</span>
<span class="c1"># Criterion &amp; Optimizer
</span>
<span class="c1"># train &amp; test
</span>
<span class="c1"># run
</span></code></pre></div></div> <p>이제 저희가 사용할 데이터를 가져오고 사용할 준비를 마쳤습니다! 🎉</p> <h3 id="model">Model</h3> <p>이제 Matrix Factorization을 수행할 모델을 구현해야 합니다. Matrix Factoriztion에 대해 간단히 설명드리면, “User와 Item을 각각 latent vector로 표현한 후, 이 둘을 행렬곱”해서 “원래의 Interaction Matrix를 예측 / 완성”하는 것입니다. latent vector는 각각의 요소가 가지고 있는 잠재적인 특성을 컴퓨터가 이해할 수 있는 ‘값’들로 나타낸 것이라 생각하시면 됩니다.</p> <p><strong>예측</strong>은 원래의 값과 모델이 만들어 낸 값과의 차이를 줄이는 과정입니다. 때문에 이 과정은 <strong>Criterion</strong>에서 처리합니다. 그럼 이 파트에서 해야하는 일은 “User와 Item을 각각 latent vector로 표현한 후, 이 둘을 행렬곱”하는 부분이겠네요.</p> <p>latent vector로 표현하는 것은 임베딩을 사용해도 되고, 랜덤값을 사용해도 됩니다. 저는 임베딩을 사용했습니다.</p> <p><strong>MF: py</strong> :</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="p">...</span>

<span class="c1"># Dataset &amp; Dataloader
</span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/movielens/ratings.csv'</span><span class="p">).</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">])</span>
<span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">batch</span> <span class="o">*</span> <span class="n">ratings_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="n">batch</span> <span class="o">*</span> <span class="n">ratings_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">...</span> 
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="c1"># Model
</span><span class="k">class</span> <span class="nc">MatrixFacotirzation</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_factor</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="s">"""
        :param n_users: number of users
        :param n_items: number of items
        :param n_factor: size of latent vector 

        """</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">user_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span> <span class="n">n_users</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="n">n_factor</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">item_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">num_embeddings</span><span class="o">=</span><span class="n">n_items</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="o">=</span><span class="n">n_factor</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="n">bmm</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">user_embedding</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">item_embedding</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># (32,1,100) x (32,100,1)
</span><span class="n">model</span> <span class="o">=</span> <span class="n">MatrixFacotirzation</span><span class="p">(</span><span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_factor</span><span class="o">=</span><span class="mi">100</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># Criterion &amp; Optimizer
</span>
<span class="c1"># train &amp; test
</span>
<span class="c1"># run
</span></code></pre></div></div> <p>각 user와 item을 100차원의 latent vector로 나타낸 후 <code class="language-plaintext highlighter-rouge">torch.bmm</code>을 이용해 <strong>batch matmul</strong>을 해주고 있습니다. <code class="language-plaintext highlighter-rouge">bmm()</code>을 사용한 이유는 dataloader가 dataset의 <code class="language-plaintext highlighter-rouge">__getitem__()</code>을 이용해 데이터를 가져올 때 지정해준 batch_size 만큼 가져오기 때문입니다. 그래서 텐서의 형태가 원래는 <code class="language-plaintext highlighter-rouge">(1,)</code>라면, batch_size가 32일 때 <code class="language-plaintext highlighter-rouge">(32,1)</code>이 되는거죠. 이럴 때 batch_size를 신경안쓰고 가져온 행렬끼리의 곱만 하고 싶을 때 사용하는 것이 <code class="language-plaintext highlighter-rouge">bmm()</code>입니다. 행렬곱을 위해 Item은 transpose해주었습니다.</p> <h3 id="criterion--optimizer">Criterion &amp; Optimizer</h3> <p>이제 모델도 만들었으니 loss function과 optimizer를 지정해야 합니다. 이 부분은 PyTorch에 내장된 것을 쓰면 되기 때문에 코드 몇 줄로 끝내면 됩니다. 다만 저희가 사용할 <strong>RMSELoss</strong>는 PyTorch에서 제공해주지 않아서, <code class="language-plaintext highlighter-rouge">MSELoss()</code>의 결과값에 square root를 취했습니다.</p> <p><strong>MF.py</strong> :</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="p">...</span>

<span class="c1"># Dataset &amp; Dataloader
</span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/movielens/ratings.csv'</span><span class="p">).</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">])</span>
<span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">batch</span> <span class="o">*</span> <span class="n">ratings_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="n">batch</span> <span class="o">*</span> <span class="n">ratings_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">...</span> 
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="c1"># Model
</span><span class="p">...</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MatrixFacotirzation</span><span class="p">(</span><span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_factor</span><span class="o">=</span><span class="mi">100</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># Criterion &amp; Optimizer
</span><span class="k">class</span> <span class="nc">RMSEloss</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="s">"""
    square root of MSELoss()
    According to docs(https://pytorch.org/docs/stable/generated/torch.nn.MSELoss.html), 
    'mean' is set by default for 'reduction' and can be avoided by 'reduction="sum"'
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">mse</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MSELoss</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">([</span><span class="n">eps</span><span class="p">]).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">rating</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">mse</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">rating</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

<span class="n">criterion</span> <span class="o">=</span> <span class="n">RMSEloss</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">lr</span><span class="p">)</span>
<span class="c1"># train &amp; test
</span>
<span class="c1"># run
</span></code></pre></div></div> <h3 id="train--test"><strong>train &amp; test</strong></h3> <p>거의 다 왔네요! 👍 이제 학습, 평가를 수행할 각각의 함수를 만들어 주면 끝입니다. 전체적인 흐름은 다음과 같습니다.</p> <ul> <li><strong>dataloader</strong>를 이용해 전체 데이터를 쪼갠 batch에 접근 <ul> <li><strong>model</strong>을 이용해 예측</li> <li>실제 값과 비교, loss값 계산</li> <li><code class="language-plaintext highlighter-rouge">backward()</code> 수행</li> <li>파라미터 수정</li> </ul> </li> </ul> <p>각각의 과정이 이미 코드로 짜여져 있거나, PyTorch 내부에서 제공하는 기능이기 때문에 이 부분도 코드 몇 줄로 끝낼 수 있습니다. 결과를 저장하고, 출력하는 코드만 조금 곁들이면 되겠네요. train 과 test는 각각 train_dataset, test_dataset을 사용하는 동일한 과정입니다.</p> <p><strong>MF.py</strong> :</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="p">...</span>

<span class="c1"># Dataset &amp; Dataloader
</span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/movielens/ratings.csv'</span><span class="p">).</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'timestamp'</span><span class="p">])</span>
<span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">batch</span> <span class="o">*</span> <span class="n">ratings_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">.</span><span class="n">batch</span> <span class="o">*</span> <span class="n">ratings_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">...</span> 
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">MovieLensDataset</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
<span class="c1"># Model
</span><span class="p">...</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MatrixFacotirzation</span><span class="p">(</span><span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_factor</span><span class="o">=</span><span class="mi">100</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="c1"># Criterion &amp; Optimizer
</span><span class="p">...</span>
<span class="n">criterion</span> <span class="o">=</span> <span class="n">RMSEloss</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">lr</span><span class="p">)</span>
<span class="c1"># train &amp; test
</span><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">item</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="n">start_dim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

        <span class="n">process</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">'[*] Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s"> [</span><span class="si">{</span><span class="n">idx</span> <span class="o">*</span> <span class="n">args</span><span class="p">.</span><span class="n">batch</span><span class="si">}</span><span class="s"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span><span class="si">}</span><span class="s">] RMSE: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">process</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">process</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">):</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">item</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="n">start_dim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">process</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">print</span> <span class="p">(</span><span class="sa">f</span><span class="s">'[*] Test RMSE: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">process</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>

<span class="c1"># run
</span></code></pre></div></div> <h3 id="run"><strong>run</strong></h3> <p>이제 다 끝났습니다. 실행만 빼고요!😊 epoch만큼 반복시키고, 각각의 결과를 저장한 후 그래프로 나타내면 모든 코드가 완성됩니다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">train_rmse</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">([]).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">test_rmse</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">([]).</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">epochs</span><span class="p">):</span>
        <span class="n">train_rmse</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">((</span><span class="n">train_rmse</span><span class="p">,</span> <span class="n">train</span><span class="p">(</span><span class="n">epoch</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">test_rmse</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">((</span><span class="n">train_rmse</span><span class="p">,</span> <span class="n">test</span><span class="p">()),</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">epochs</span><span class="p">),</span><span class="n">train_rmse</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">epochs</span><span class="p">),</span><span class="n">test_rmse</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'epoch'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'RMSE'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <h2 id="-conclusion">❗ Conclusion</h2> <p><img src="https://user-images.githubusercontent.com/51329156/106496851-b3731080-6500-11eb-9bc1-5937d6605189.png" alt="Figure_2" /></p> <p>주황색 선은 test 결과 이고, 파란색 선은 train 결과입니다. 거의 비슷하네요. 저는 epoch을 30으로 했는데 결과를 보니 20으로 했을 때와 별 차이가 없습니다.</p> <h2 id="-ng">🔎 NG</h2> <p>이 코드를 작성하면서 몇가지 문제들을 마주쳤습니다… 그 부분에 대해 제가 생각하는 원인과 해결방법을 말씀 드리고 글을 마무리하려고 합니다. 정확하진 않으니 참고만 해주세요!</p> <h3 id="1-loss가-줄어들지-않음">1. Loss가 줄어들지 않음</h3> <p>처음에 코드를 짤 때는 ratings.csv를 그대로 사용하지 않고, <strong>pandas</strong>의 <code class="language-plaintext highlighter-rouge">pivot()</code>을 사용해 user와 item의 interaction matrix로 만들어 사용했습니다. 그렇게 되면 중간에 빈 값이 생기게 되는데, <strong>numpy</strong>의 <code class="language-plaintext highlighter-rouge">nonzero()</code>를 사용해 채워진 값만 가져오는 식으로 했습니다. 근데 이 부분에서 어떤 문제가 있었는지… loss가 15~18에서 왔다갔다 하면서 도저히 감소를 하지 않았습니다.. 그래서 그냥 원래 데이터를 그대로 사용하는 방식으로 돌아왔더니 정상화되었습니다. 그 와중에 바꾼 게 또 있었기 때문에 확신은 못하겠지만, 제가 생각하기에는 그렇습니다!</p> <h3 id="2--user--itemsum1-">2. (user * item).sum(1) ??</h3> <p>이 부분은 문제라기 보단 의문이 들어서 넣어봤습니다.</p> <p>위의 연산은 user와 item 행렬을 elemet wise 하게 연산한 후, 같은 row에 있는 값들을 다 더하겠다는 의미입니다. 구글링을 해보면 많은 사람들이 이렇게 MF를 구현했는데… 저는 이해가 되지 않았습니다. 저는 <code class="language-plaintext highlighter-rouge">matmul(user, item.T)</code>를 해야 의미상 맞지 않나라고 생각했거든요. 여기에 대해서는 더 알아보는 중입니다!</p> <p>이렇게 MF를 PyTorch로 구현하는 데에 성공했네요. 다음에는 아래의 순서대로 논문을 읽고, 구현해보려고 합니다. 주변에 추천시스템을 공부하는 친구가 없어 외로웠는데 갓갓 선배님 <em>adldotori</em> 께서 이걸 주셨습니다. 더 열심히 해야겠네요.. 글 읽고 모르는 부분은 제 프로필에 있는 연락처로 연락 주시면 답변드리겠습니다. 감사합니다! 😆</p> <p><img src="https://user-images.githubusercontent.com/51329156/106468911-e0fc9180-64e1-11eb-8be7-cc61c51c3d8b.jpg" alt="KakaoTalk_20210201_224448751" /></p> <br /><!-- Load Facebook SDK for JavaScript --> <div id="fb-root"></div> <script> (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) return; js = d.createElement(s); js.id = id; js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0"; fjs.parentNode.insertBefore(js, fjs); })(document, "script", "facebook-jssdk"); </script> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script><!-- Author box --> <div class="card"> <div class="card-header"> About Jo Byeonggeun </div> <div class="card-body"> <div class="row"> <div class="col-md-4"> <img class="author-profile-img" src="https://www.bbangjo.kr/assets/img/authors/bbangjo.png" alt="Jo Byeonggeun" /> </div> <div class="col-md-6"> <p class="author_bio">Hello World</p> <p>Email : airmancho@korea.ac.kr</p> <p>Website : </p> <p class="profile-links"> <a class="social-link" href="https://github.com/bbangjooo" target="_blank"><i class="fab fa-github fa-fw"></i></a> </p> </div> </div> </div> </div> </div><div id="disqus_thread"></div> </article> <div id="disqus_thread"></div> <script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */ var disqus_config = function () { this.page.url = 'https://www.bbangjo.kr/blog/recsys-mfpytorch'; this.page.identifier = 'https://www.bbangjo.kr/blog/recsys-mfpytorch'; }; (function() { // DON'T EDIT BELOW THIS LINE var d = document, s = d.createElement('script'); s.src = 'https://blog-5znfc8zdfx.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div> </div> <div class="row"> <div class="col-md-4"> <div class="card"> <div class="card-header">About bbangjo</div> <div class="card-body"> <p class="author_bio">Hi, my name is Jo Byeonggeun.</p> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Categories</div> <div class="card-body text-dark"> <div id="#Recommendation System"></div> <li class="tag-head"> <a href="/blog/categories/Recommendation System">Recommendation System</a> </li> <a name="Recommendation System"></a> </div> </div> </div> <div class="col-md-4"> <div class="card"> <div class="card-header">Useful Links</div> <div class="card-body text-dark"> <li> <a href="https://www.bbangjo.kr/">Home</a> </li> <li> <a href="https://www.bbangjo.kr/about">About</a> </li> <li> <a href="https://www.bbangjo.kr/blog">Blog</a> </li> </div> </div> </div> </div> </div> <div class="col-lg-12" id="newsletter_footer"><!-- Mailchimp Newletters --></div><footer> <p> Powered by<a href="https://github.com/sujaykundu777/devlopr-jekyll"> devlopr jekyll</a>.Hosted at <a href="https://pages.github.com">Github</a>. Subscribe via <a href=" /feed.xml ">RSS</a> </p> </footer> <script> var options = { classname: 'progressline', id: 'my-id' }; var nanobar = new Nanobar( options ); nanobar.go( 30 ); nanobar.go( 76 ); nanobar.go(100); </script> <div hidden id="snipcart" data-api-key="Y2I1NTAyNWYtMTNkMy00ODg0LWE4NDItNTZhYzUxNzJkZTI5NjM3MDI4NTUzNzYyMjQ4NzU0"></div> <script src="https://cdn.snipcart.com/themes/v3.0.0-beta.3/default/snipcart.js" defer></script> <script src="https://www.bbangjo.kr/assets/js/mode-switcher.js"></script> <script> if (window.netlifyIdentity) { window.netlifyIdentity.on("init", user => { if (!user) { window.netlifyIdentity.on("login", () => { document.location.href = "/admin/"; }); } }); } </script> <!-- olvy releases --> <!-- <script> var OlvyConfig = { organisation: "", target: "#olvy-target", type: "", view: { showSearch: true, compact: true, showHeader: true, /* only applies when widget type is embed. you cannot hide header for modal and sidebar widgets */ showUnreadIndicator: true, unreadIndicatorColor: "#FFA13AFF", unreadIndicatorPosition: "top-right" } }; </script> <script type="text/javascript" src="https://app.olvy.co/script.js" defer="defer"></script> --> </body> </html>
